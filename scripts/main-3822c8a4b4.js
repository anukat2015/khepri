var app;!function(e){"use strict";var t=angular.module("app",["http-auth-interceptor","ngStorage","ui.router","ui.bootstrap","ngResize","fi.seco.sparql"]);t.config(["$stateProvider","$urlRouterProvider","configuration",function(e,t,n){t.otherwise("/"),e.state("main",{url:"/",templateUrl:n.mainView,controller:"MainController"}),e.state("configure",{url:"/configure",templateUrl:"partials/configure.html",controller:"ConfigureController"})}])}(app||(app={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=function(){function e(){}return e}();e.Config=t;var n=function(){function e(e,t){e.config=t,this.config=e.config}return e.$inject=["$localStorage","configuration"],e.$componentName="configService",e}();angular.module("app").service("configService",n),e.ConfigService=n}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=function(){function e(e){this.name=e,this.active=!1}return e}();e.Query=t;var n=function(){function e(){this._queries={}}return Object.defineProperty(e.prototype,"queries",{get:function(){return this._queries},enumerable:!0,configurable:!0}),e.prototype.getQueryState=function(e){return this._queries[e]||(this.queries[e]=new r),this._queries[e]},e}(),r=function(){function e(){this.constraints={}}return e}();e.QueryState=r;var a=function(){function e(e,t){this.constraintString=e,this.order=t}return e}();e.SimpleConstraint=a;var i=function(){function e(e){this.$rootScope=e,this.state=new n}return e.$inject=["$rootScope"],e.$componentName="stateService",e.prototype.setConstraint=function(e,t,n){this.state.getQueryState(e).constraints[t]=n,this.$rootScope.$broadcast("updateConstraint",e,t)},e.prototype.getQueries=function(){return this.state.queries},e.prototype.getQueryState=function(e){return this.state.getQueryState(e)},e.prototype.setQueryState=function(e,t){this.state[e]=t,this.$rootScope.$broadcast("updateConstraint",e)},e.prototype.getConstraintString=function(e,t){void 0===t&&(t={});var n=[];for(var r in this.state.getQueryState(e).constraints)t[r]||(n[this.state.queries[e].constraints[r].order]||(n[this.state.queries[e].constraints[r].order]=""),n[this.state.queries[e].constraints[r].order]+=this.state.queries[e].constraints[r].constraintString);var a="";return n.filter(function(e){return""!==e}).forEach(function(e){return a+=e}),a},e}();angular.module("app").service("stateService",i),e.StateService=i}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(t){var n;!function(t){"use strict";var n=e.seco.sparql,r=function(){function e(e,t,n,r){this.constraintString=e,this.sparqlRegex=t,this.jsRegex=n,this.luceneQuery=r,this.order=1}return e}();t.TextSearchConstraint=r;var a=function(){function e(e,t,a,i){var o=this;this.$q=e,this.sparqlService=t,this.configService=a,this.stateService=i,this.restrict="E",this.templateUrl="partials/textsearchview.html",this.scope={viewId:"@",queryId:"="},this.link=function(e,t,a){var i=o.configService.config.viewConfiguration[a.$normalize(e.viewId)];e.constraints={},e.keywords=[],e.setConstraint=function(t,n){void 0===n&&(n=!1),t?n?(e.constraints={},e.constraints[t]=!0):e.constraints[t]?delete e.constraints[t]:e.constraints[t]=!0:(e.constraints={},Object.keys(e.constraints).length!==e.keywords.length&&e.keywords.forEach(function(t){return e.constraints[t.keyword]=!0}));var a="",s="",c="",l="";if(Object.keys(e.constraints).length>0){for(var u in e.constraints)c+='\\"'+u+'\\" ',a+=u.replace(/ /g,"\\\\s+")+"|",s+=u.replace(/ /g,"\\s+")+"|";c=c.substr(0,c.length-1),a="(?:\\\\b"+a.substr(0,a.length-1)+"\\\\b)",s="(?:\\b"+s.substr(0,s.length-1)+"\\b)",l=i.constraintString.replace(/<LUCENE_REGEX>/g,c).replace(/<SPARQL_REGEX>/g,a)}o.stateService.setConstraint(e.queryId,e.viewId,new r(l,a,s,c))};var s=function(){o.canceler.resolve(),o.canceler=o.$q.defer();var t="+/"+e.query.replace(/ /g,"/ +/").replace(/\*/g,"[^ ]*").replace(/\?/g,"[^ ]?")+"/",r="\\\\b"+e.query.replace(/ /g,"\\\\s+").replace(/\*/g,"\\\\w*").replace(/\?/g,"\\\\w?")+"\\\\b",a={};a[e.viewId]=!0;var s=o.stateService.getConstraintString(e.queryId,a);o.sparqlService.query(o.configService.config.sparqlEndpoint,o.configService.config.prefixes+i.textSearchQuery.replace(/# CONSTRAINTS/g,s).replace(/<LUCENE_REGEX>/g,t).replace(/<SPARQL_REGEX>/g,r),{timeout:o.canceler.promise}).then(function(t){var r=e.keywords,a={};e.keywords=t.data.results.bindings.map(function(e){var t=n.SparqlService.bindingsToObject(e);return a[t.keyword]=!0,t}),r.filter(function(t){return!a[t.keyword]&&e.constraints[t.keyword]}).forEach(function(t){return e.keywords.push(t)})},function(e){return console.log(e)})};e.$on("updateConstraint",function(t,n,r){n===e.queryId&&r!==e.viewId&&e.query&&s()}),e.$watch("query",function(e){e&&s()})},this.canceler=e.defer()}return e.$inject=["$q","sparqlService","configService","stateService"],e.$componentName="textSearchView",e}();angular.module("app").directive("textSearchView",["$q","sparqlService","configService","stateService",function(){return new(Function.prototype.bind.apply(a,[null].concat(Array.prototype.slice.call(arguments))))}]),t.TextSearchViewDirective=a}(n=t.khepri||(t.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=function(){function e(e,t,n){this.before=e,this.match=t,this.after=n}return e}(),n=function(){function e(e,t,n,r,a,i){this.id=e,this.label=t,this.fulltext=n,this.snippet=r,this.metadata=a,this.filtered=i}return e}(),r=function(){function r(r,a,i,o,s,c){var l=this;this.$timeout=r,this.$q=a,this.$sce=i,this.sparqlService=o,this.configService=s,this.stateService=c,this.restrict="E",this.templateUrl="partials/resultlistview.html",this.scope={width:"=",viewId:"@",showMetadata:"=",queryId:"="},this.link=function(r,a,i){r.orderBy="match",r.orderByDescending=!1;var o=l.configService.config.viewConfiguration[i.$normalize(r.viewId)],s=function(){var a="(?:",i=l.stateService.getQueryState(r.queryId).constraints;for(var s in i)i[s]instanceof e.TextSearchConstraint&&(a+=i[s].sparqlRegex+"|");"|"===a.charAt(a.length-1)&&(a=a.substring(0,a.length-1)),a+=")";var c={};c[r.viewId]=!0;var u=l.stateService.getConstraintString(r.queryId,c);l.canceler.resolve(),l.canceler=l.$q.defer(),l.sparqlService.query(l.configService.config.sparqlEndpoint,l.configService.config.prefixes+o.resultQuery.replace(/# CONSTRAINTS/g,u).replace(/<SPARQL_REGEX>/g,a).replace(/<ORDER_BY>/g,r.orderByDescending?"DESC(?"+r.orderBy+")":"?"+r.orderBy)).then(function(e){r.metadataKeys=[],r.showMetadata&&e.data.head.vars.forEach(function(e){"metadata"===e.substring(0,8)&&r.metadataKeys.push(e.substring(8))}),r.results=e.data.results.bindings.map(function(e){var a=void 0,i=[];r.metadataKeys.forEach(function(t){return i.push(e["metadata"+t].value)});var o=document.createElement("div");o.textContent=e.fulltext.value,a=o.innerHTML;var s;if(e.match){var c,u,p,g=new RegExp("("+e.match.value+")"),d=a.split(g);a="";for(var h=0;h<d.length;h+=2)c=u,d[h].length>r.width?(p=d[h].substring(0,r.width),u=d[h].substring(d[h].length-r.width)):(p=d[h],u=d[h]),a+=d[h].length>1e3?d[h].substring(0,500)+'<span class="red">...</span>'+d[h].substring(d[h].length-500):d[h],a+='<span class="blue">',d.length>h+1&&(a+=d[h+1]),a+="</span>";s=new t(l.$sce.trustAsHtml(c),e.match.value,l.$sce.trustAsHtml(p))}return a=l.$sce.trustAsHtml(a),new n(e.id.value,e.label.value,a,s,i,l.filtered[e.id.value])})},function(e){return console.log(e)})};r.setOrderBy=function(e){r.orderBy===e?r.orderByDescending=!r.orderByDescending:(r.orderBy=e,r.orderByDescending=!1),s()},r.filter=function(t,n){if(n)window.open(t.id,"_blank");else{t.filtered=!t.filtered,l.filtered[t.id]=t.filtered;var a="FILTER (";for(var i in l.filtered)l.filtered[i]&&(a+="?id!=<"+i+"> && ");a=a.substr(0,a.length-4)+")","FILT)"===a&&(a=""),l.stateService.setConstraint(r.queryId,r.viewId,new e.SimpleConstraint(a,2))}},r.$watch("width",function(e,t){e&&s()}),r.$on("updateConstraint",function(e,t,n){t===r.queryId&&n!==r.viewId&&s()})},this.filtered={},this.canceler=a.defer()}return r.$inject=["$timeout","$q","$sce","sparqlService","configService","stateService"],r.$componentName="resultListView",r}();angular.module("app").directive("resultListView",["$timeout","$q","$sce","sparqlService","configService","stateService",function(){return new(Function.prototype.bind.apply(r,[null].concat(Array.prototype.slice.call(arguments))))}]),e.ResultListViewDirective=r}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=function(){function e(e,t,n){this.id=e,this.label=t,this.instances=n,this.children=[],this.matchingInstances=n}return e}(),n=function(){function e(e,t){this.constraintString=e,this.values=t,this.order=5}return e.prototype.clone=function(){return new e(this.constraintString,this.values.slice())},e}(),r=function(){function e(e,r,a,i){var o=this;this.$q=e,this.configService=r,this.stateService=a,this.sparqlService=i,this.scope={viewId:"@",queryId:"=",viewConfiguration:"="},this.restrict="E",this.templateUrl="partials/treeview.html",this.link=function(e,r,a){var i=e.viewConfiguration?e.viewConfiguration:o.configService.config.viewConfiguration[a.$normalize(e.viewId)];e.constraints=[],e.selectElement=function(t,r){void 0===r&&(r=!1),console.log(e.queryId,e.viewId),r?e.constraints.push(t):e.constraints=[t];var a="";e.constraints.forEach(function(e){a+="{ "+i.constraintString.replace(/<CONSTRAINT_ID>/g,"<"+e.id+">")+" } UNION"}),a=a.substr(0,a.length-6),o.stateService.setConstraint(e.queryId,e.viewId,new n(a,e.constraints))},e.isSelected=function(t){return-1!==e.constraints.indexOf(t)},o.sparqlService.query(o.configService.config.sparqlEndpoint,i.getTreeQuery).then(function(n){var r={},a={};n.data.results.bindings.forEach(function(e){if(e.subClass){var n=e.subClass.value;r[n]||(r[n]={}),r[n][e.superClass.value]=!0}else a[e["class"].value]=new t(e["class"].value,e.classLabel.value,parseInt(e.instances.value,10))}),e.tree=[];for(var i in a)if(r[i])for(var o in r[i])a[o].children.push(a[i]);else e.tree.push(a[i])},function(e){return console.log(e)}),e.$on("updateConstraint",function(t,n,r){o.canceler.resolve();var a={};a[e.viewId]=!0;var s=o.stateService.getConstraintString(e.queryId,a);o.sparqlService.query(o.configService.config.sparqlEndpoint,o.configService.config.prefixes+i.getCountsQuery.replace(/# CONSTRAINTS/g,s)).then(function(t){var n={};t.data.results.bindings.forEach(function(e){return n[e["class"].value]=parseInt(e.instances.value,10)}),e.tree.forEach(function(e){return o.updateCounts(e,n)})},function(e){return console.log(e)})})},this.updateCounts=function(e,t){e.matchingInstances=t[e.id]?t[e.id]:0,e.children.forEach(function(e){return o.updateCounts(e,t)})},this.canceler=e.defer()}return e.$inject=["$q","configService","stateService","sparqlService"],e.$componentName="treeView",e}();angular.module("app").directive("treeView",["$q","configService","stateService","sparqlService",function(){return new(Function.prototype.bind.apply(r,[null].concat(Array.prototype.slice.call(arguments))))}]),e.TreeViewDirective=r}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=function(){function e(){}return e}();e.ChartDefinition=t;var n=function(){function e(e){this.resize=e,this.restrict="E",this.template='<div style="width:100%"></div>',this.scope={chartDefinition:"="},this.link=function(e,t,n){var r=new google.visualization.ChartWrapper({chartType:e.chartDefinition.type,options:e.chartDefinition.options,dataTable:e.chartDefinition.dataTable});e.$watch("chartDefinition.dataTable",function(n,a){n!==a&&(r.setChartType(e.chartDefinition.type),r.setOptions(e.chartDefinition.options),r.setDataTable(e.chartDefinition.dataTable),r.draw(t[0].children[0]))}),e.$on("resize",function(){e.chartDefinition.dataTable&&r.draw(t[0].children[0])}),google.visualization.events.addListener(r,"select",function(){return e.chartDefinition.select(r.getChart().getSelection(),e.chartDefinition,r)}),e.chartDefinition.dataTable&&r.draw(t[0].children[0])}}return e.$inject=["resize"],e.$componentName="googleChartView",e}();angular.module("app").directive("googleChartView",["resize",function(){return new(Function.prototype.bind.apply(n,[null].concat(Array.prototype.slice.call(arguments))))}]),e.GoogleChartViewDirective=n}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var fi;!function(e){var t;!function(e){var t;!function(e){"use strict";var t=(function(){function e(){}return e}(),function(){function e(e,t,n){var r=this;this.sparqlService=e,this.configService=t,this.stateService=n,this.restrict="E",this.templateUrl="partials/multitreeviews.html",this.scope={viewId:"@",queryId:"="},this.link=function(e,t,n){e.views=[{id:"property-tree-view",label:"Education",viewConfiguration:r.configService.config.viewConfiguration[n.$normalize("property-tree-view")]}]}}return e.$inject=["sparqlService","configService","stateService"],e.$componentName="multiTreeViews",e}());angular.module("app").directive("multiTreeViews",["sparqlService","configService","stateService",function(){return new(Function.prototype.bind.apply(t,[null].concat(Array.prototype.slice.call(arguments))))}]),e.MultiTreeViewsDirective=t}(t=e.khepri||(e.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},fi;!function(e){var t;!function(t){var n;!function(t){"use strict";var n=e.seco.sparql,r=function(){function e(){this.matchesByYearAndQueryAndGroupAndAggregation={},this.totalsByYearAndGroupAndAggregation={},this.queries={},this.groups={},this.groupsByAggregation={},this.minYear=Number.MAX_VALUE,this.maxYear=Number.MIN_VALUE}return e}(),a=function(e){function t(t,n){e.call(this),this.queryId=t,this.select=n}return __extends(t,e),t}(t.ChartDefinition),i=function(){function e(e,t){this.id=e,this.label=t}return e}(),o=function(){function e(r,o,s){var c=this;this.sparqlService=r,this.configService=o,this.stateService=s,this.restrict="E",this.templateUrl="partials/multigooglechartviews.html",this.scope={viewId:"@",queries:"="},this.link=function(r,o,s){var l=c.configService.config.viewConfiguration[s.$normalize(r.viewId)];r.avgType="total",r.movingSpan=20,r.graphType="individual",r.bootstraps=1,r.selectedGrouping=null,c.sparqlService.query(c.configService.config.sparqlEndpoint,l.partitionsQuery).then(function(e){return r.availableGroupings=e.data.results.bindings.map(function(e){return new i(e.property.value,e.propertyLabel.value)})},function(e){return console.log(e)});var u=function(e,n,a){var i;if(0!==e.length){var o=n.dataTable.getValue(e[0].row,0);i="?id cs:year ?year . FILTER (STRDT(?year,xsd:integer)>"+(o-r.movingSpan/2)+" && STRDT(?year,xsd:integer)<"+(o+r.movingSpan/2)+") ";var s=n.dataTable.getColumnId(e[0].column);s&&(i+="?id crm:P28_custody_surrendered_by/<"+r.selectedGrouping.id+"> <"+s+"> .")}else i="";c.stateService.setConstraint(n.queryId,r.viewId,new t.SimpleConstraint(i,2))},p=function(){var i=l.graphQuery.split(/[\{\}] # \/?CONSTRAINTHOLDER/),o=i[0];r.queries.forEach(function(e){var a="(?:",s=c.stateService.getQueryState(e.name).constraints;for(var l in s)s[l]instanceof t.TextSearchConstraint&&(a+=s[l].sparqlRegex+"|");"|"===a.charAt(a.length-1)&&(a=a.substring(0,a.length-1)),a+=")","(?:)"===a&&(a="^$");var u={};u[r.viewId]=!0;var p=c.stateService.getConstraintString(e.name,u);o+="{"+i[1].replace(/<QUERY_ID>/g,n.SparqlService.stringToSPARQLString(e.name)).replace(/# CONSTRAINTS/g,p).replace(/<REGEX>/g,n.SparqlService.stringToSPARQLString(a))+"} UNION"}),o=o.substring(0,o.length-6)+i[2];var s,p=r.selectedGrouping?"?id crm:P28_custody_surrendered_by/<"+r.selectedGrouping.id+"> ?group . ?group sf:preferredLanguageLiteral (skos:prefLabel rdfs:label 'en' '' ?l)":"";switch(r.avgType){case"total":s="";break;case"text":s="BIND(?id AS ?aggrId)";break;case"author":s="?id crm:P28_custody_surrendered_by ?aggrId .";break;default:throw"Unknown avgType "+r.avgType}o=c.configService.config.prefixes+o.replace(/# AGGREGATION/g,s).replace(/# GROUPING/g,p),c.sparqlService.query(c.configService.config.sparqlEndpoint,o).then(function(t){var n=e.processData(t.data.results.bindings),i={};r.charts.forEach(function(e){return i[e.queryId]=e}),"scattercomparison"===r.graphType?i.scatterComparison||(r.charts=[new a("scatterComparison",u)]):r.separateGroups||"areacomparison"===r.graphType?r.charts=Object.keys(n.groups).map(function(e){return i[e]?i[e]:new a(e,u)}):r.charts=r.queries.map(function(e){return i[e.name]?i[e.name]:new a(e.name,u)});var o,s,c,l,p=[],g=[];if("scattercomparison"===r.graphType)c=["Scatterplot"];else if(r.separateGroups||"areacomparison"===r.graphType){o=n.groups,c=[];for(var d in n.groups)c.push(n.groups[d]);s=n.queries,l=Object.keys(n.queries)}else{o=n.queries,c=Object.keys(n.queries),s=n.groups,l=[];for(var d in n.groups)l.push(n.groups[d])}r.charts.forEach(function(e,t){switch(e.dataTable=new google.visualization.DataTable,r.graphType){case"areacomparison":e.type="AreaChart";break;case"individual":e.type="LineChart";break;case"scattercomparison":e.type="MotionChart";break;default:throw"Unknown graphType "+r.graphType}var n={};"scattercomparison"===r.graphType&&e.dataTable.addColumn("string","id"),e.dataTable.addColumn("number","year");var a=0;"scattercomparison"!==r.graphType?l.forEach(function(t,i){e.dataTable.addColumn({id:s[i],label:t,type:"number"}),r.accumulation||(e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"}),e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"}),e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"}),e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"}),e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"}),e.dataTable.addColumn({id:s[i],label:t,role:"interval",type:"number"})),n[a++]={targetAxisIndex:0},"individual"!==r.graphType||!r.accumulation&&r.hideTotals||(e.dataTable.addColumn({id:s[i],label:t+" total",type:"number"}),n[a++]={targetAxisIndex:r.accumulation?0:1,lineWidth:1,lineDashStyle:[5,5],visibleInLegend:!1})}):(e.dataTable.addColumn("number","percentage of "+r.queries[1].name),e.dataTable.addColumn("number","total number of matches"),e.dataTable.addColumn("string",r.selectedGrouping?r.selectedGrouping.label:"matching")),e.options={title:c[t],explorer:{keepInBounds:!0,maxZoomOut:1},theme:"material",isStacked:"percent",hAxis:{title:"year",format:"#"},intervals:{style:"line"},series:n,vAxes:{0:{title:r.accumulation?"Percent":"Matches/million",minValue:0,maxValue:"areacomparison"===r.graphType?1:10},1:{title:"Count",gridlines:{color:"none"},minValue:0,logScale:!0}}},p[t]={},g[t]={}});var h=[];h.length=c.length;for(var v=0;v<h.length;v++)h[v]=[];for(var f=r.accumulation&&"individual"===r.graphType?0:Math.floor(r.movingSpan/2),m=n.minYear;m<=n.maxYear;m++){var y=0;if("scattercomparison"===r.graphType){var b={},w={};for(var S in n.queries)for(var A in n.groups)for(var v=m-f;m+f>=v;v++)if(n.totalsByYearAndGroupAndAggregation[v]&&n.matchesByYearAndQueryAndGroupAndAggregation[v]&&n.matchesByYearAndQueryAndGroupAndAggregation[v][S]&&n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A])for(var q in n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A])w[q]=!0,b[q]||(b[q]={}),b[q][S]?b[q][S]+=n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A][q]:b[q][S]=n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A][q];var C=Object.keys(n.queries);for(var k in w){var T=[k,m,100*b[k][C[1]]/(b[k][C[1]]+b[k][C[0]]),b[k][C[0]]+b[k][C[1]]];for(var d in n.groupsByAggregation[k]){var I=T.slice();I.push(d),h[0].push(I)}}}else for(var $ in o){var T=[];T.push(m);for(var x in s){var S=void 0,A=void 0;r.separateGroups||"areacomparison"===r.graphType?(S=x,A=$):(S=$,A=x);for(var G=[],B=[],E=[],Q=0;Q<r.bootstraps;Q++)E[Q]=0,B[Q]={},G[Q]={};for(var v=m-f;m+f>=v;v++)if(n.totalsByYearAndGroupAndAggregation[v]&&n.totalsByYearAndGroupAndAggregation[v][A])for(var Q=0;Q<r.bootstraps;Q++){var Y=Object.keys(n.totalsByYearAndGroupAndAggregation[v][A]),w=[];if(1===r.bootstraps)w=Y;else for(var D=0;D<Y.length;D++)w[D]=Y[Math.floor(Math.random()*Y.length)];if(n.matchesByYearAndQueryAndGroupAndAggregation[v]&&n.matchesByYearAndQueryAndGroupAndAggregation[v][S]&&n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A])for(var N=0;N<w.length;N++){var q=w[N];n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A][q]&&(G[Q][q]?G[Q][q]+=n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A][q]:G[Q][q]=n.matchesByYearAndQueryAndGroupAndAggregation[v][S][A][q])}if(n.totalsByYearAndGroupAndAggregation[v][A])for(var N=0;N<w.length;N++){var q=w[N];B[Q][q]?B[Q][q]+=n.totalsByYearAndGroupAndAggregation[v][A][q]:B[Q][q]=n.totalsByYearAndGroupAndAggregation[v][A][q],E[Q]+=n.totalsByYearAndGroupAndAggregation[v][A][q]}}for(var O=[],Q=0;Q<r.bootstraps;Q++){O[Q]=0;for(var q in B[Q])B[Q][q]&&(O[Q]+=1e6*(G[Q][q]?G[Q][q]:0)/B[Q][q])}if(O.sort(function(e,t){return e-t}),r.accumulation&&"individual"===r.graphType){g[y][A]||(g[y][A]=0,p[y][A]=0);var R=Math.floor(r.bootstraps/2);p[y][A]+=0!==Object.keys(B[R]).length?O[R]/Object.keys(B[R]).length:0,g[y][A]+=E[Math.floor(r.bootstraps/2)],T.push(p[y][A]),T.push(g[y][A])}else{if(0!==Object.keys(B).length){var R=Math.floor(r.bootstraps/2);T.push(O[R]/Object.keys(B[R]).length),R=Math.floor(r.bootstraps/100),T.push(O[R]/Object.keys(B[R]).length),R=Math.floor(r.bootstraps/20),T.push(O[R]/Object.keys(B[R]).length),R=Math.floor(r.bootstraps/10),T.push(O[R]/Object.keys(B[R]).length),R=r.bootstraps-1-Math.floor(r.bootstraps/10),T.push(O[R]/Object.keys(B[R]).length),R=r.bootstraps-1-Math.floor(r.bootstraps/20),T.push(O[R]/Object.keys(B[R]).length),R=r.bootstraps-1-Math.floor(r.bootstraps/100),T.push(O[R]/Object.keys(B[R]).length)}else T.push(0),T.push(0),T.push(0),T.push(0),T.push(0),T.push(0),T.push(0);r.hideTotals||"individual"!==r.graphType||T.push(E[Math.floor(r.bootstraps/2)])}}h[y++].push(T)}}r.accumulation&&"individual"===r.graphType&&h.forEach(function(e,t){return e.forEach(function(e){var r=1;Object.keys(n.groups).forEach(function(n){e[r]=100*e[r++]/p[t][n],e[r]=100*e[r++]/g[t][n]})})}),h.forEach(function(e,t){return r.charts[t].dataTable.addRows(e)})},function(e){return console.log(e)})};r.$watchCollection("[selectedGrouping, graphType, movingSpan, hideTotals, avgType, separateGroups, accumulation, bootstraps]",function(e,t){e!==t&&p()}),r.$on("updateConstraint",function(e,t,n){n!==r.viewId&&p()}),r.charts=[],r.$watch(function(){return r.queries.map(function(e){return e.name})},function(e,t){p()},!0),r.$watchCollection("queries",function(e,t){e!==t&&p()}),p()}}return e.$inject=["sparqlService","configService","stateService"],e.$componentName="multiGoogleChartViews",e.processData=function(e){for(var t=new r,n=0;!e[n].queryId;){var a=e[n++],i=parseInt(a.year.value,10);i>t.maxYear&&(t.maxYear=i),i<t.minYear&&(t.minYear=i),t.totalsByYearAndGroupAndAggregation[i]||(t.totalsByYearAndGroupAndAggregation[i]={});var o=a.group?a.group.value:"matching";t.totalsByYearAndGroupAndAggregation[i][o]||(t.totalsByYearAndGroupAndAggregation[i][o]={});var s=a.aggrId?a.aggrId.value:"";t.groupsByAggregation[s]||(t.groupsByAggregation[s]={}),t.groupsByAggregation[s][o]=!0,t.totalsByYearAndGroupAndAggregation[i][o][s]=parseInt(a.total.value,10),t.groups[o]=a.groupLabel?a.groupLabel.value:o}for(;n<e.length;){var a=e[n++],i=parseInt(a.year.value,10);t.matchesByYearAndQueryAndGroupAndAggregation[i]||(t.matchesByYearAndQueryAndGroupAndAggregation[i]={});var c=a.queryId.value;t.matchesByYearAndQueryAndGroupAndAggregation[i][c]||(t.matchesByYearAndQueryAndGroupAndAggregation[i][c]={});var o=a.group?a.group.value:"matching";t.matchesByYearAndQueryAndGroupAndAggregation[i][c][o]||(t.matchesByYearAndQueryAndGroupAndAggregation[i][c][o]={}),t.queries[c]=!0;var s=a.aggrId?a.aggrId.value:"";t.matchesByYearAndQueryAndGroupAndAggregation[i][c][o][s]=parseInt(a.matching.value,10)}return t},e}();angular.module("app").directive("multiGoogleChartViews",["sparqlService","configService","stateService",function(){return new(Function.prototype.bind.apply(o,[null].concat(Array.prototype.slice.call(arguments))))}]),t.MultiGoogleChartViewsDirective=o}(n=t.khepri||(t.khepri={}))}(t=e.seco||(e.seco={}))}(fi||(fi={})),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/ceecs-main.html",'\n<div class="container-fluid">\n  <div class="row">\n    <uib-tabset ng-class="state==\'filter\' ? \'col-xs-12\' : (state==\'visualization\' ? \'col-xs-4\': \'col-xs-8\')">\n      <uib-tab ng-repeat="query in queries" active="query.active">\n        <uib-tab-heading><span ng-show="!editingName" ng-click="query.active &amp;&amp; (editingName=true)">{{query.name}}</span>\n          <input ng-show="editingName" ng-model="newName" ng-init="newName=query.name" ng-blur="renameQuery(query,newName)" ng-keyup="($event.keyCode == 13 &amp;&amp; (renameQuery(query,newName) || true) &amp;&amp; (editingName=false)) || ($event.keyCode == 27 &amp;&amp; (editingName=false))"/><span ng-show="query.active" ng-click="removeQuery(query)" class="glyphicon glyphicon-remove"></span>\n        </uib-tab-heading>\n        <div class="container-fluid">\n          <div class="row">\n            <div ng-class="state==\'filter\' ? \'col-xs-2\' : (state==\'visualization\' ? \'col-xs-12\' : \'col-xs-3\')">\n              <h4>Constrain</h4>\n              <text-search-view view-id="text-search-view" query-id="query.name"></text-search-view>\n              <multi-tree-views view-id="property-tree-views" query-id="query.name"></multi-tree-views>\n            </div>\n            <div ng-class="state==\'filter\' ? \'col-xs-10\' : \'col-xs-9\'" ng-show="state!=\'visualization\'">\n              <h4>Filter\n                <button ng-click="$parent.$parent.$parent.state= $parent.$parent.$parent.state==\'filter\' ? \'normal\' : \'filter\'" class="btn btn-sm btn-default"><span class="glyphicon glyphicon-resize-horizontal"></span></button>\n              </h4>\n              <result-list-view width="state==\'filter\' ? 60 : 40" show-metadata="state==\'filter\'" view-id="result-list-view" query-id="query.name"></result-list-view>\n            </div>\n          </div>\n        </div>\n      </uib-tab>\n      <uib-tab select="addQuery()">\n        <uib-tab-heading><span class="glyphicon glyphicon-plus"></span></uib-tab-heading>\n      </uib-tab>\n    </uib-tabset>\n    <div ng-class="state==\'visualization\' ? \'col-xs-8\' : \'col-xs-4\'" ng-show="state!=\'filter\'">\n      <h4>View\n        <button ng-click="state= state==\'visualization\' ? \'normal\' : \'visualization\';resize()" class="btn btn-sm btn-default"><span class="glyphicon glyphicon-resize-horizontal"></span></button>\n      </h4>\n      <multi-google-chart-views view-id="google-chart-view" queries="queries"></multi-google-chart-views>\n    </div>\n  </div>\n</div>')}])}(),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/multigooglechartviews.html",'\n<google-chart-view ng-repeat="chart in charts" chart-definition="chart"></google-chart-view>\n<div class="form-horizontal">\n  <div class="form-group"> \n    <label>Partition:</label>\n    <select ng-model="selectedGrouping" ng-options="availableGrouping.label for availableGrouping in availableGroupings" class="form-control">\n      <option value="">total</option>\n    </select>\n  </div>\n  <div class="form-group">\n    <label>Sample length (years):</label>\n    <input type="text" ng-model="movingSpan" class="form-control"/>\n  </div>\n  <div class="form-group">\n    <label>Graph type:</label>\n    <div class="btn-group">\n      <label ng-model="graphType" uib-btn-radio="\'individual\'" class="btn btn-sm btn-success">individual</label>\n      <label ng-model="graphType" uib-btn-radio="\'areacomparison\'" ng-disabled="queries.length &lt; 2" class="btn btn-sm btn-success">compare as area</label>\n      <label ng-model="graphType" uib-btn-radio="\'scattercomparison\'" ng-disabled="queries.length !== 2" class="btn btn-sm btn-success">compare as scatterplot</label>\n    </div>\n  </div>\n</div>\n<div ng-show="graphType == \'individual\'" class="form-inline">\n  <div class="checkbox">\n    <label> \n      <input type="checkbox" ng-model="hideTotals" ng-disabled="accumulation"/>\n    </label>&nbsp;Hide totals\n  </div>\n  <div class="checkbox">\n    <label> \n      <input type="checkbox" ng-model="accumulation"/>\n    </label>&nbsp;Show as accumulation chart\n  </div>\n  <div ng-show="selectedGrouping!=\'\'" class="checkbox">\n    <label> \n      <input type="checkbox" ng-model="separateGroups"/>\n    </label>&nbsp;Partitions as charts\n  </div>\n</div>\n<div class="form-horizontal"> \n  <div class="form-group">\n    <label>Calculate values as:</label>\n    <div class="btn-group">\n      <label ng-model="avgType" uib-btn-radio="\'total\'" class="btn btn-sm btn-primary">total</label>\n      <label ng-model="avgType" uib-btn-radio="\'text\'" class="btn btn-sm btn-primary">text average</label>\n      <label ng-model="avgType" uib-btn-radio="\'author\'" class="btn btn-sm btn-primary">author average</label>\n    </div>\n  </div>\n  <div class="form-group">\n    <label>Number of bootstraps:</label>\n    <input type="text" ng-model="bootstraps" ng-model-options="{updateOn : \'change blur\'}" ng-disabled="avgType === \'total\'" class="form-control"/>\n  </div>\n</div>')}])}(),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/multitreeviews.html",'\n<div ng-repeat="view in views">\n  <label>{{view.label}}</label>\n  <tree-view view-id="viewId" query-id="queryId" view-configuration="view.viewConfiguration"></tree-view>\n</div>\n<div class="form-group">\n  <select ng-model="newView" ng-options="availableView.label for availableView in availableViews">\n    <option></option>\n  </select>\n</div>')}])}(),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/resultlistview.html",'\n<script type="text/ng-template" id="popover.html">\n  <div ng-bind-html="result.fulltext" class="small black"></div>\n</script>\n<table infinite-scroll="scrollInstances()" infinite-scroll-parent="infinite-scroll-parent" infinite-scroll-distance="5">\n  <tr class="item selected">\n    <th colspan="3" ng-click="setOrderBy(\'match\')">Context <span ng-show="orderBy==\'match\' &amp;&amp; !orderByDescending" class="glyphicon glyphicon-triangle-top"></span><span ng-show="orderBy==\'match\' &amp;&amp; orderByDescending" class="glyphicon glyphicon-triangle-bottom"></span></th>\n    <th ng-repeat="key in metadataKeys" ng-click="setOrderBy(\'metadata\'+key)">{{::key}} <span ng-show="orderBy==\'metadata\'+key &amp;&amp; !orderByDescending" class="glyphicon glyphicon-triangle-top"></span><span ng-show="orderBy==\'metadata\'+key &amp;&amp; orderByDescending" class="glyphicon glyphicon-triangle-bottom"></span></th>\n  </tr>\n  <tr ng-repeat="result in results" ng-click="filter(result,$event.ctrlKey||$event.metaKey)" ng-style="result.filtered ? {\'text-decoration\': \'line-through\'} : {}" uib-popover-template="\'popover.html\'" popover-trigger="mouseenter" popover-title="{{result.label}}" popover-placement="bottom" class="item selected">\n    <td ng-if="result.snippet" ng-bind-html="result.snippet.before" class="text-right"> </td>\n    <th ng-if="result.snippet" class="text-center">&nbsp;{{::result.snippet.match}}&nbsp;</th>\n    <td ng-if="result.snippet" ng-bind-html="result.snippet.after" class="text-left"></td>\n    <td ng-if="!result.snippet" colspan="3">{{::result.label}}</td>\n    <td ng-repeat="metadata in result.metadata">&nbsp;{{::metadata}}</td>\n  </tr>\n</table>');
}])}(),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/textsearchview.html",'\n<div class="form-group">\n  <label>Search</label>\n  <input ng-model="query" ng-model-options="{ debounce: 300 }" ng-keyup="$event.keyCode == 13 &amp;&amp; setConstraint()" class="form-control"/>\n</div>\n<ul infinite-scroll="scrollInstances()" infinite-scroll-parent="infinite-scroll-parent" infinite-scroll-distance="5" class="list-unstyled">\n  <li ng-repeat="keyword in keywords" ng-click="setConstraint(keyword.keyword,$event.ctrlKey||$event.metaKey)" ng-class="{selected:constraints[keyword.keyword]}" class="item"> <span>{{::keyword.keyword}}</span><span class="item-count pull-right">{{keyword.matchingInstances}}<span ng-show="keyword.totalInstances!=keyword.matchingInstances">/{{::keyword.totalInstances}}</span></span></li>\n</ul>')}])}(),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/treeview.html",'\n<script type="text/ng-template" id="treenode.html"><span>{{node.label}}</span><span class="pull-right">{{node.matchingInstances}}/{{node.instances}}</span>\n  <ul class="list-unstyled">\n    <li ng-repeat="node in node.children" ng-include="\'treenode.html\'" ng-click="selectElement(node,$event.ctrlKey);$event.stopPropagation()" ng-class="{selected:isSelected(node)}" class="item"></li>\n  </ul>\n</script>\n<ul class="list-unstyled">\n  <li ng-repeat="node in tree" ng-include="\'treenode.html\'" ng-click="selectElement(node,$event.ctrlKey);$event.stopPropagation()" ng-class="{selected:isSelected(node)}" class="item"></li>\n</ul>')}])}();